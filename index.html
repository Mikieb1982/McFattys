<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>McFatty's Food Tracker</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@600;700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1115">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
  <link rel="preload" href="Logo.png" as="image">

  <style>
    :root{
      --bg-0:#0f1115; --bg-1:#171a21; --card:#1c2028;
      --text-0:#f2f3f5; --text-1:#c9ced6; --border:#2a2f39;
      --primary:#ffc857; --success:#57d2a9; --danger:#ff6b6b; --info:#7aa2ff;
      --sp-4:4px; --sp-8:8px; --sp-12:12px; --sp-16:16px; --sp-20:20px; --sp-24:24px;
      --fs-22:22px; --fs-18:18px; --fs-16:16px; --fs-14:14px; --lh:1.45;
      --r-8:8px; --r-12:12px; --r-16:16px; --shadow-md:0 8px 20px rgba(0,0,0,.35);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg-0);color:var(--text-0);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:var(--lh)}
    .container{max-width:860px;margin:0 auto;padding:var(--sp-12) var(--sp-16) var(--sp-24)}
    .stack-16 > *+*{margin-top:var(--sp-16)}
    .stack-20 > *+*{margin-top:var(--sp-20)}

    /* Top bar */
    .utility-bar{position:sticky;top:0;z-index:300;padding:calc(var(--sp-8)+var(--safe-top)) var(--sp-8) var(--sp-8);
      margin:0 calc(-1*var(--sp-16)) var(--sp-12);
      background:linear-gradient(180deg,rgba(23,26,33,.95),rgba(23,26,33,.75) 70%,rgba(23,26,33,0));
      backdrop-filter:blur(4px)}
    .utility-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0 var(--sp-8)}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:12px;border:1px solid #2d3441;background:#232834;color:var(--text-0);cursor:pointer;transition:.15s}
    .icon-btn:active{transform:scale(.98)}
    .icon{width:22px;height:22px;display:block}

    /* Lang toggle */
    .lang-toggle{display:inline-flex;align-items:center;gap:var(--sp-8);user-select:none;cursor:pointer}
    .lang-toggle span{font-size:12px;font-weight:700}
    .switch{position:relative;width:50px;height:28px;background:#232834;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow-md) inset 0 0 4px rgba(0,0,0,.3);transition:.25s}
    .switch::after{content:"";position:absolute;top:2px;left:2px;width:24px;height:24px;background:var(--primary);border-radius:50%;transition:.25s}
    .switch.active{background:#3b3f4a}
    .switch.active::after{left:24px}

    /* Buttons */
    .btn{padding:12px 18px;border-radius:var(--r-12);font-weight:700;cursor:pointer;min-height:44px;transition:.15s;border:1px solid transparent;display:inline-flex;align-items:center;justify-content:center}
    .btn:active{transform:scale(.98)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .btn-primary{background:var(--primary);color:#1b1b1b}
    .btn-secondary{background:#232834;color:var(--text-0);border-color:#2d3441}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{background:#e25555}
    .btn:focus,.input:focus,.switch:focus-visible,.icon-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(255,200,87,.35)}

    /* Install button hidden unless prompted */
    #pwa-install{padding:12px 16px;font-size:14px;line-height:1;white-space:nowrap;max-width:100%;display:none}
    @media (max-width:620px){.utility-row{flex-wrap:wrap;gap:12px}#pwa-install{width:100%}}

    /* Logo (2/3 size) */
    .hero-logo{background:var(--bg-1);border-radius:var(--r-12);box-shadow:var(--shadow-md);padding:var(--sp-8)}
    .hero-logo img{width:100%;max-width:320px;display:block;margin:0 auto}

    /* Sections */
    .section{background:var(--card);border:1px solid var(--border);border-radius:var(--r-12);box-shadow:var(--shadow-md);padding:18px}
    .section h2{font-family:Oswald,sans-serif;font-weight:700;font-size:var(--fs-22);margin:0 0 var(--sp-12)}
    .section-head{display:flex;justify-content:space-between;align-items:center}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .label{font-size:var(--fs-14);color:var(--text-1);margin-bottom:var(--sp-8);display:block}
    .input{width:100%;background:#12151b;color:var(--text-0);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
    .checkbox{width:20px;height:20px;cursor:pointer;margin-right:var(--sp-8)}
    .controls{display:flex;flex-wrap:wrap;gap:var(--sp-12);align-items:flex-end}
    .controls .grow{flex:1 1 260px}

    /* Table */
    .table{width:100%;border-collapse:separate;border-spacing:0 var(--sp-8)}
    .table thead th{color:var(--text-1);font-size:13px;font-weight:600;text-align:left;padding-bottom:4px}
    .table tbody tr{background:#141821;border:1px solid var(--border);border-radius:var(--r-8)}
    .table tbody td{padding:10px}
    .row-actions{text-align:right}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .pill-yes{background:rgba(87,210,169,.18);color:#a6efd9}
    .pill-no{background:rgba(255,107,107,.18);color:#ffc1c1}

    .footer{color:var(--text-1);font-size:12px;text-align:center;padding:14px 0}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:500}
    .modal-backdrop.show{display:flex}
    .modal{background:var(--card);padding:20px;border-radius:var(--r-12);text-align:center;max-width:360px;width:90%}
    .modal h3{margin:0 0 10px;font-family:Oswald,sans-serif;font-size:20px}
    .modal p{margin:0 0 16px;color:var(--text-1)}
    .modal-actions{display:flex;gap:10px;justify-content:center;margin-top:16px}

    /* Toast (centered) */
    .install-banner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.96);opacity:0;background:var(--card);color:var(--text-0);padding:16px 22px;border:1px solid var(--border);border-radius:var(--r-16);box-shadow:var(--shadow-md);font-weight:700;font-size:14px;display:none;z-index:550;transition:opacity .2s ease,transform .2s ease}
    .install-banner.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1)}

    /* Sidebar (right) */
    .scrim{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:450}
    .scrim.show{display:block}
    .sidebar{position:fixed;top:0;right:0;height:100%;width:300px;max-width:85%;background:var(--card);border-left:1px solid var(--border);box-shadow:var(--shadow-md);transform:translateX(100%);transition:transform .22s ease-out;z-index:600;display:flex;flex-direction:column}
    .sidebar.open{transform:translateX(0)}
    .sb-head{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--border)}
    .sb-title{font-family:Oswald,sans-serif;font-size:18px;margin:0}
    .sb-section-title{padding:12px 14px;color:var(--text-1);font-size:12px;text-transform:uppercase;letter-spacing:.05em}
    .sb-list{list-style:none;margin:0;padding:0}
    .sb-item-btn{width:100%;text-align:left;padding:12px 14px;background:none;color:var(--text-0);border:none;border-top:1px solid rgba(255,255,255,.02);cursor:pointer;display:flex;align-items:center;gap:10px}
    .sb-item-btn:focus{outline:none;box-shadow:inset 0 0 0 2px rgba(255,200,87,.35)}
    .sb-item-btn:hover{background:#161a22}
    .sb-item-icon{width:18px;height:18px;opacity:.9}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media (prefers-reduced-motion:reduce){.install-banner,.sidebar{transition:none}.btn:active{transform:none}}
    
    @media (min-width: 680px) {
      .hero-logo img {
        max-width: 240px;
      }
    }
  </style>
</head>
<body>
  <div id="scrim" class="scrim" tabindex="-1" aria-hidden="true"></div>
  <aside id="sidebar" class="sidebar" aria-hidden="true" aria-labelledby="menu-title" role="dialog">
    <div class="sb-head">
      <h3 id="menu-title" class="sb-title" data-i18n="menuTitle">Menu</h3>
      <button id="menu-close" class="icon-btn" aria-label="Close menu">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M18.3 5.7L12 12l6.3 6.3-1.3 1.3L10.7 13.3 4.4 19.6 3.1 18.3 9.4 12 3.1 5.7 4.4 4.4l6.3 6.3 6.3-6.3z"/></svg>
      </button>
    </div>
    <div>
      <div class="sb-section-title" data-i18n="corePractices">Core Practices</div>
      <ul class="sb-list">
        <li><button class="sb-item-btn" data-action="newEntry"><svg class="sb-item-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 11H13V5h-2v6H5v2h6v6h2v-6h6z"/></svg><span data-i18n="newJournal">New Journal Entry</span></button></li>
      </ul>
      <div class="sb-section-title" data-i18n="settings">Application Settings</div>
      <ul class="sb-list">
        <li><button class="sb-item-btn" data-action="account"><svg class="sb-item-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg><span data-i18n="account">Account</span></button></li>
        <li><button class="sb-item-btn" data-action="logout"><svg class="sb-item-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M16 17v-3H9v-2h7V9l4 4-4 4zm-5-3H4V5h7V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h7v-2z"></path></svg><span data-i18n="logout">Log Out</span></button></li>
      </ul>
    </div>
  </aside>

  <div id="install-banner" class="install-banner" role="status" aria-live="polite"></div>

  <div class="container stack-20">
    <div class="utility-bar" role="region" aria-label="App controls">
      <div class="utility-row">
        <div id="lang-toggle" class="lang-toggle" role="button" tabindex="0" aria-label="Toggle language EN/DE">
          <span>EN</span><div id="switch" class="switch" aria-hidden="true"></div><span>DE</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <button id="pwa-install" class="btn btn-secondary" type="button" aria-label="Install app" data-i18n="installBtn">Install</button>
          <button id="menu-open" class="icon-btn" aria-label="Open menu">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <header class="hero-logo"><img src="Logo.png" alt="McFatty's Food Tracker logo"></header>

    <div id="landing-page">
        <section id="auth-section" class="section stack-16">
            <h2 id="auth-title" data-i18n="loginTitle">Login / Sign Up</h2>
            <div id="auth-fields-container" class="stack-16"></div>
            <div class="controls" style="margin-top: 16px;">
                <button id="auth-submit" class="btn btn-primary" type="button"></button>
                <button id="auth-toggle" class="btn btn-secondary" type="button"></button>
            </div>
        </section>
        <section id="about-section" class="section">
            <h2 data-i18n="manifestoTitle">McFatty's Manifesto</h2>
            <p data-i18n="manifestoP1">McFatty’s Food Tracker is not about calories, restrictions, or guilt. If you want chips, eat them. No shame, no punishment. Just write it down. Recording without judgment is the act that matters.</p>
            <p data-i18n="manifestoP2">This app is free. No subscriptions, no upsells, no lifestyle packages. We reject the idea that food and health should be sold back to us. Eating should not be a business model.</p>
            <p data-i18n="manifestoP3">Instead, McFatty’s helps you pause, check in with your body, and notice your habits. Consciously or subconsciously, the simple act of logging allows you to see patterns and slowly shift your relationship with food. Change should not be a race. It should be slow, gentle, and rooted in respect for your choices.</p>
            <p data-i18n="manifestoP4">We are against cycles of guilt, shame, and impossible promises. We will not celebrate consumerism dressed up as self-care. We believe the radical choice is to slow down, listen to yourself, and eat on your own terms.</p>
            <p data-i18n="manifestoP5">The app will always be free to use. There is a donation button for those who want to support, because while the world should be free, it isn’t. But McFatty’s will never profit from your guilt.</p>
            <button id="donate-button" class="btn btn-primary" type="button" data-i18n="donateBtn">Donate</button>
        </section>
    </div>

    <div id="app-content" style="display: none;">
        <section id="welcome-section" class="section">
            <h2 id="welcome-message"></h2>
        </section>
        <section class="section stack-16" aria-labelledby="addItem" id="add-item-section">
          <h2 id="addItem" data-i18n="addTitle">Add item</h2>
          <div class="controls">
            <div class="grow">
              <label for="food-name" class="label" data-i18n="foodLabel">Food item name</label>
              <input id="food-name" class="input" type="text" placeholder="e.g., Cheeseburger" autocomplete="off">
            </div>
            <button id="add-button" class="btn btn-primary" type="button" data-i18n="addBtn">Add to log</button>
          </div>
          <label style="display:flex;align-items:center;margin-top:var(--sp-8);">
            <input id="contains-dairy" type="checkbox" class="checkbox" aria-label="Contains dairy">
            <span data-i18n="dairyLabel">Contains dairy</span>
          </label>
        </section>

        <section class="section stack-16" aria-labelledby="todaysLog" id="log-section">
          <div class="section-head">
            <h2 id="todaysLog" data-i18n="logTitle">Today’s log</h2>
            <button id="export-button" class="btn btn-secondary" type="button" data-i18n="exportBtn">Export</button>
          </div>
          <table class="table" aria-describedby="todaysLog">
            <thead><tr><th data-i18n="thItem">Item</th><th data-i18n="thDairy">Dairy</th><th></th></tr></thead>
            <tbody id="log-body"></tbody>
          </table>
          <div id="empty-state" class="label" style="display:none" data-i18n="emptyState">No items yet. Add your first item above.</div>
        </section>
    </div>

    <footer class="footer" data-i18n="footerText">Designed and created by Burrow · 2025</footer>
  </div>

  <div class="modal-backdrop" id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-desc">
    <div class="modal">
      <h3 id="confirm-title">Are you sure?</h3>
      <p id="confirm-desc"></p>
      <div class="modal-actions">
        <button id="cancel-action" class="btn btn-secondary" data-i18n="cancelBtn">Cancel</button>
        <button id="confirm-action" class="btn btn-danger" data-i18n="confirmClearBtn">Confirm</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="account-modal" role="dialog" aria-modal="true" aria-labelledby="account-title">
    <div class="modal">
      <h3 id="account-title" data-i18n="accountModalTitle">Edit Account</h3>
      <div class="stack-16" style="text-align: left;">
          <label for="account-name" class="label" data-i18n="nameLabel">Name</label>
          <input id="account-name" class="input" type="text" placeholder="e.g., Mike">
          <label for="account-email" class="label" data-i18n="emailLabel">Email</label>
          <input id="account-email" class="input" type="email" disabled>
      </div>
      <div class="modal-actions">
        <button id="delete-account" class="btn btn-danger" data-i18n="deleteAccountBtn">Delete Account</button>
        <button id="cancel-account" class="btn btn-secondary" data-i18n="cancelBtn">Cancel</button>
        <button id="save-account" class="btn btn-primary" data-i18n="saveBtn">Save</button>
      </div>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let logCollection;
    let unsubscribe;
    let lang = 'en';

    // Elements
    const nameInput = document.getElementById('food-name');
    const dairyCheckbox = document.getElementById('contains-dairy');
    const addBtn = document.getElementById('add-button');
    const tbody = document.getElementById('log-body');
    const emptyState = document.getElementById('empty-state');
    const toastEl = document.getElementById('install-banner');
    const sidebar = document.getElementById('sidebar');
    const scrim = document.getElementById('scrim');
    const welcomeSection = document.getElementById('welcome-section');
    const welcomeMessage = document.getElementById('welcome-message');
    const landingPage = document.getElementById('landing-page');
    const appContent = document.getElementById('app-content');
    const donateBtn = document.getElementById('donate-button');
    const langToggle = document.getElementById('lang-toggle');
    const switchEl = document.getElementById('switch');

    // Auth Elements
    const authFieldsContainer = document.getElementById('auth-fields-container');
    const authSubmit = document.getElementById('auth-submit');
    const authToggle = document.getElementById('auth-toggle');

    // Account Modal Elements
    const accountModal = document.getElementById('account-modal');
    const accountNameInput = document.getElementById('account-name');
    const accountEmailInput = document.getElementById('account-email');
    const saveAccountBtn = document.getElementById('save-account');
    const cancelAccountBtn = document.getElementById('cancel-account');
    const deleteAccountBtn = document.getElementById('delete-account');

    // Confirmation Modal Elements
    const confirmModal = document.getElementById('confirm-modal');
    const confirmDesc = document.getElementById('confirm-desc');
    const cancelActionBtn = document.getElementById('cancel-action');
    const confirmActionBtn = document.getElementById('confirm-action');

    let isLogin = true;

    const i18n = {
      en: {
        loginTitle: "Login / Sign Up",
        loginLabel: "Login",
        signupLabel: "Sign Up",
        needAccountLabel: "Need an account?",
        haveAccountLabel: "Have an account?",
        manifestoTitle: "McFatty's Manifesto",
        manifestoP1: "McFatty’s Food Tracker is not about calories, restrictions, or guilt. If you want chips, eat them. No shame, no punishment. Just write it down. Recording without judgment is the act that matters.",
        manifestoP2: "This app is free. No subscriptions, no upsells, no lifestyle packages. We reject the idea that food and health should be sold back to us. Eating should not be a business model.",
        manifestoP3: "Instead, McFatty’s helps you pause, check in with your body, and notice your habits. Consciously or subconsciously, the simple act of logging allows you to see patterns and slowly shift your relationship with food. Change should not be a race. It should be slow, gentle, and rooted in respect for your choices.",
        manifestoP4: "We are against cycles of guilt, shame, and impossible promises. We will not celebrate consumerism dressed up as self-care. We believe the radical choice is to slow down, listen to yourself, and eat on your own terms.",
        manifestoP5: "The app will always be free to use. There is a donation button for those who want to support, because while the world should be free, it isn’t. But McFatty’s will never profit from your guilt.",
        donateBtn: "Donate",
        addTitle: "Add item",
        foodLabel: "Food item name",
        addBtn: "Add to log",
        dairyLabel: "Contains dairy",
        logTitle: "Today’s log",
        exportBtn: "Export",
        thItem: "Item",
        thDairy: "Dairy",
        emptyState: "No items yet. Add your first item above.",
        footerText: "Designed and created by Burrow · 2025",
        menuTitle:"Menu",
        corePractices:"Core Practices",
        newJournal:"New Journal Entry",
        settings:"Application Settings",
        account:"Account",
        logout:"Log Out",
        installBtn:"Install",
        accountModalTitle:"Edit Account",
        nameLabel:"Name",
        emailLabel:"Email",
        deleteAccountBtn:"Delete Account",
        saveBtn:"Save",
        cancelBtn:"Cancel",
        confirmClearBtn:"Confirm",
        pillYes:"Yes",
        pillNo:"No",
        toastAdded:"✅ Added",
        toastRemoved:"🗑️ Removed",
        toastExported:"📄 Exported",
      },
      de: {
        loginTitle: "Anmelden / Registrieren",
        loginLabel: "Anmelden",
        signupLabel: "Registrieren",
        needAccountLabel: "Brauchst du ein Konto?",
        haveAccountLabel: "Hast du ein Konto?",
        manifestoTitle: "McFatty's Manifest",
        manifestoP1: "Bei McFatty’s Food Tracker geht es nicht um Kalorien, Einschränkungen oder Schuld. Wenn du Chips willst, iss sie. Keine Scham, keine Bestrafung. Schreib es einfach auf. Das urteilsfreie Notieren ist der entscheidende Akt.",
        manifestoP2: "Diese App ist kostenlos. Keine Abonnements, keine Zusatzverkäufe, keine Lifestyle-Pakete. Wir lehnen die Vorstellung ab, dass uns Essen und Gesundheit zurückverkauft werden sollten. Essen sollte kein Geschäftsmodell sein.",
        manifestoP3: "Stattdessen hilft McFatty’s dir, innezuhalten, auf deinen Körper zu hören und deine Gewohnheiten zu bemerken. Bewusst oder unbewusst ermöglicht dir das einfache Protokollieren, Muster zu erkennen und deine Beziehung zum Essen langsam zu verändern. Veränderung sollte kein Wettlauf sein. Sie sollte langsam, sanft und in Respekt vor deinen Entscheidungen verwurzelt sein.",
        manifestoP4: "Wir sind gegen Zyklen von Schuld, Scham und unmöglichen Versprechen. Wir werden keinen als Selbstfürsorge getarnten Konsumismus feiern. Wir glauben, die radikale Wahl ist, zu verlangsamen, auf sich selbst zu hören und zu seinen eigenen Bedingungen zu essen.",
        manifestoP5: "Die App wird immer kostenlos sein. Es gibt einen Spenden-Button für diejenigen, die unterstützen möchten, denn obwohl die Welt frei sein sollte, ist sie es nicht. Aber McFatty’s wird niemals von deiner Schuld profitieren.",
        donateBtn: "Spenden",
        addTitle: "Eintrag hinzufügen",
        foodLabel: "Name des Lebensmittels",
        addBtn: "Zum Protokoll hinzufügen",
        dairyLabel: "Enthält Milchprodukte",
        logTitle: "Heutiges Protokoll",
        exportBtn: "Exportieren",
        thItem: "Artikel",
        thDairy: "Milchprodukte",
        emptyState: "Noch keine Einträge. Füge oben deinen ersten hinzu.",
        footerText: "Entworfen und erstellt von Burrow · 2025",
        menuTitle:"Menü",
        corePractices:"Kernpraktiken",
        newJournal:"Neuer Journaleintrag",
        settings:"App-Einstellungen",
        account:"Konto",
        logout:"Abmelden",
        installBtn:"Installieren",
        accountModalTitle:"Konto bearbeiten",
        nameLabel:"Name",
        emailLabel:"Email",
        deleteAccountBtn:"Konto löschen",
        saveBtn:"Speichern",
        cancelBtn:"Abbrechen",
        confirmClearBtn:"Bestätigen",
        pillYes:"Ja",
        pillNo:"Nein",
        toastAdded:"✅ Hinzugefügt",
        toastRemoved:"🗑️ Entfernt",
        toastExported:"📄 Exportiert",
      }
    };

    function setLanguage(newLang) {
      lang = newLang;
      localStorage.setItem('mcfattys_lang', lang);
      const elements = document.querySelectorAll('[data-i18n]');
      elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });
      switchEl.classList.toggle('active', lang === 'de');
      renderAuthForm();
    }

    function showToast(message, duration = 2000) {
      toastEl.textContent = message;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), duration);
    }
    
    function render(items = []) {
      const t = i18n[lang] || i18n.en;
      tbody.innerHTML = '';
      emptyState.style.display = items.length ? 'none' : 'block';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td><span class="pill ${item.dairy ? 'pill-yes' : 'pill-no'}">${item.dairy ? t.pillYes : t.pillNo}</span></td>
          <td class="row-actions"><button class="btn btn-danger" onclick="removeItem('${item.id}')">${lang === 'de' ? 'Entfernen' : 'Remove'}</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addItem() {
      const name = nameInput.value.trim();
      if (!name || !logCollection) return;
      try {
        await logCollection.add({
          name: name,
          dairy: dairyCheckbox.checked,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        nameInput.value = '';
        dairyCheckbox.checked = false;
        nameInput.focus();
        showToast(i18n[lang].toastAdded);
      } catch (error) { showToast(`⚠️ Error: ${error.message}`); }
    }

    window.removeItem = async function(docId) {
      if (!logCollection) return;
      try {
        await logCollection.doc(docId).delete();
        showToast(i18n[lang].toastRemoved);
      } catch (error) { showToast(`⚠️ Error: ${error.message}`); }
    }

    function renderAuthForm() {
        const t = i18n[lang] || i18n.en;
        authSubmit.textContent = isLogin ? t.loginLabel : t.signupLabel;
        authToggle.textContent = isLogin ? t.needAccountLabel : t.haveAccountLabel;
        
        let fieldsHtml = `
            <div class="controls"><div class="grow"><label for="auth-email" class="label">${t.emailLabel || 'Email Address'}</label><input id="auth-email" class="input" type="email" autocomplete="email"></div></div>
            <div class="controls"><div class="grow"><label for="auth-password" class="label">${lang === 'de' ? 'Passwort' : 'Password'}</label><input id="auth-password" class="input" type="password" autocomplete="${isLogin ? 'current-password' : 'new-password'}"></div></div>
        `;
        if (!isLogin) {
            fieldsHtml += `
                <div class="controls"><div class="grow"><label for="auth-username" class="label">${lang === 'de' ? 'Benutzername' : 'Username'}</label><input id="auth-username" class="input" type="text" autocomplete="username"></div></div>
                <div class="controls"><div class="grow"><label for="auth-re-password" class="label">${lang === 'de' ? 'Passwort wiederholen' : 'Re-type Password'}</label><input id="auth-re-password" class="input" type="password" autocomplete="new-password"></div></div>
            `;
        }
        authFieldsContainer.innerHTML = fieldsHtml;
    }

    async function handleAuthSubmit() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        try {
            if (isLogin) {
                await auth.signInWithEmailAndPassword(email, password);
            } else {
                const rePassword = document.getElementById('auth-re-password').value;
                const username = document.getElementById('auth-username').value;
                if (password !== rePassword) { showToast(lang === 'de' ? 'Passwörter stimmen nicht überein.' : 'Passwords do not match.'); return; }
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({
                    username: username,
                    email: email,
                    name: username
                });
                showToast(`${lang === 'de' ? 'Willkommen' : 'Welcome'}, ${username}!`);
            }
        } catch (error) { showToast(`⚠️ Error: ${error.message}`); }
    }

    async function showApp(user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();
        welcomeMessage.textContent = `${lang === 'de' ? 'Willkommen' : 'Welcome'}, ${userData.name}!`;
        landingPage.style.display = 'none';
        appContent.style.display = 'block';

        logCollection = db.collection('users').doc(user.uid).collection('log');
        if (unsubscribe) unsubscribe();
        unsubscribe = logCollection.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            render(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }, error => showToast(`⚠️ Error: ${error.message}`));
    }

    function showAuth() {
        if (unsubscribe) unsubscribe();
        logCollection = null;
        render([]);
        landingPage.style.display = 'block';
        appContent.style.display = 'none';
        isLogin = true;
        renderAuthForm();
    }

    async function openAccountModal() {
        const user = auth.currentUser;
        if (!user) return;
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                accountNameInput.value = userData.name || '';
                accountEmailInput.value = userData.email || '';
            }
            accountModal.classList.add('show');
        } catch (error) {
            showToast(`⚠️ Could not load user data.`);
        }
    }

    async function saveAccountDetails() {
        const user = auth.currentUser;
        const newName = accountNameInput.value.trim();
        if (!user || !newName) return;
        try {
            await db.collection('users').doc(user.uid).update({ name: newName });
            accountModal.classList.remove('show');
            showToast('✅ Account updated!');
        } catch (error) {
            showToast(`⚠️ Error saving details.`);
        }
    }

    function confirmDeletion() {
        confirmDesc.textContent = "Are you sure you want to delete your account? This will permanently delete all of your data.";
        confirmModal.classList.add('show');
        confirmActionBtn.onclick = async () => {
            const user = auth.currentUser;
            if (user) {
                try {
                    const logSnapshot = await db.collection('users').doc(user.uid).collection('log').get();
                    const batch = db.batch();
                    logSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await db.collection('users').doc(user.uid).delete();
                    await user.delete();
                    confirmModal.classList.remove('show');
                    showToast('Account deleted successfully.');
                } catch (error) {
                    showToast(`⚠️ Error deleting account.`);
                }
            }
        };
    }

    function handleMenuAction(action) {
      sidebar.classList.remove('open');
      scrim.classList.remove('show');
      switch(action) {
        case 'newEntry': appContent.scrollIntoView({ behavior: 'smooth' }); break;
        case 'account': openAccountModal(); break;
        case 'logout': auth.signOut(); break;
        default: showToast('Coming soon'); break;
      }
    }
    
    // Initial Load
    const savedLang = localStorage.getItem('mcfattys_lang') || 'en';
    setLanguage(savedLang);

    // Bindings
    auth.onAuthStateChanged(user => user ? showApp(user) : showAuth());
    addBtn?.addEventListener('click', addItem);
    authToggle.addEventListener('click', () => { isLogin = !isLogin; renderAuthForm(); });
    authSubmit.addEventListener('click', handleAuthSubmit);
    langToggle.addEventListener('click', () => setLanguage(lang === 'en' ? 'de' : 'en'));
    document.getElementById('menu-open')?.addEventListener('click', () => { sidebar.classList.add('open'); scrim.classList.add('show'); });
    document.getElementById('menu-close')?.addEventListener('click', () => { sidebar.classList.remove('open'); scrim.classList.remove('show'); });
    scrim?.addEventListener('click', () => { sidebar.classList.remove('open'); scrim.classList.remove('show'); });
    sidebar?.addEventListener('click', e => {
      const btn = e.target.closest('.sb-item-btn');
      if (btn) handleMenuAction(btn.getAttribute('data-action'));
    });
    saveAccountBtn.addEventListener('click', saveAccountDetails);
    cancelAccountBtn.addEventListener('click', () => accountModal.classList.remove('show'));
    deleteAccountBtn.addEventListener('click', confirmDeletion);
    cancelActionBtn.addEventListener('click', () => confirmModal.classList.remove('show'));
    donateBtn.addEventListener('click', () => showToast('Donation feature coming soon!'));
  </script>
</body>
</html>
