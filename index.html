<script>
  const STORAGE_KEY='mcFattys.items.v2';
  const LANG_KEY='mcFattys.lang.v1';

  const nameInput=document.getElementById('food-name');
  const dairyCheckbox=document.getElementById('contains-dairy');
  const addBtn=document.getElementById('add-button');
  const exportBtn=document.getElementById('export-button');
  const clearBtn=document.getElementById('clear-all');
  const tbody=document.getElementById('log-body');
  const emptyState=document.getElementById('empty-state');
  const modal=document.getElementById('confirm-modal');
  const cancelClear=document.getElementById('cancel-clear');
  const confirmClear=document.getElementById('confirm-clear');

  const langToggle=document.getElementById('lang-toggle');
  const switchEl=document.getElementById('switch');

  const installBtn=document.getElementById('pwa-install');
  const toastEl=document.getElementById('install-banner');

  // Sidebar elements
  const scrim=document.getElementById('scrim');
  const sidebar=document.getElementById('sidebar');
  const menuOpen=document.getElementById('menu-open');
  const menuClose=document.getElementById('menu-close');

  // Keep ONLY this one
  let deferredPrompt=null;

  const state={items:[]};
  let lang='en';

  function showToast(message, duration=2000){
    toastEl.textContent=message;
    toastEl.classList.add('show');
    toastEl.style.display='block';
    clearTimeout(toastEl._hideT);
    toastEl._hideT=setTimeout(()=>{
      toastEl.classList.remove('show');
      setTimeout(()=>{ toastEl.style.display='none'; },200);
    },duration);
  }

  const i18n={
    en:{
      menuTitle:"Menu",
      corePractices:"Core Practices",
      newJournal:"New Journal Entry",
      photoJournal:"Photo Journal",
      hunger:"Hunger Check-in",
      reflectGrow:"Reflection & Growth",
      myJournal:"My Journal",
      intentions:"My Intentions",
      settings:"Application Settings",
      reminders:"Reminders",
      theme:"Theme",
      account:"Account",

      installBtn:"Install",
      addTitle:"Add item",foodLabel:"Food item name",addBtn:"Add to log",dairyLabel:"Contains dairy",
      logTitle:"Today’s log",exportBtn:"Export",clearAllBtn:"Clear all",thItem:"Item",thDairy:"Dairy",
      pillYes:"Yes",pillNo:"No",
      modalTitle:"Clear all logs?",modalDesc:"Are you sure you want to clear today’s log? This cannot be undone.",
      cancelBtn:"Cancel",confirmClearBtn:"Yes, clear",
      emptyState:"No items yet. Add your first item above.",
      footerText:"Designed and created by Burrow · 2025",
      toastAdded:"✅ Added",
      toastRemoved:"🗑️ Removed",
      toastExported:"📄 Exported",
      toastInstalledTray:"✅ Installed to app tray",
      toastInstalled:"✅ App installed",
      helperEmpty:"Enter a name",
      toastSoon:"Coming soon",

      hungerTitle:"Hunger Check-in",
      hungerDesc:"Notice body cues like hunger, fullness, and energy. This section will add a simple, number-free check-in soon."
    },
    de:{
      menuTitle:"Menü",
      corePractices:"Kernpraktiken",
      newJournal:"Neuer Journaleintrag",
      photoJournal:"Foto-Journal",
      hunger:"Hunger Check-in",
      reflectGrow:"Reflexion & Wachstum",
      myJournal:"Mein Journal",
      intentions:"Meine Intentionen",
      settings:"App-Einstellungen",
      reminders:"Erinnerungen",
      theme:"Design",
      account:"Konto",

      installBtn:"Installieren",
      addTitle:"Eintrag hinzufügen",foodLabel:"Name des Lebensmittels",addBtn:"Zur Liste hinzufügen",dairyLabel:"Enthält Milchprodukte",
      logTitle:"Heutiges Protokoll",exportBtn:"Exportieren",clearAllBtn:"Alles löschen",thItem:"Artikel",thDairy:"Milchprodukte",
      pillYes:"Ja",pillNo:"Nein",
      modalTitle:"Alle Einträge löschen?",modalDesc:"Möchtest du das heutige Protokoll wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.",
      cancelBtn:"Abbrechen",confirmClearBtn:"Ja, löschen",
      emptyState:"Noch keine Einträge. Füge oben deinen ersten hinzu.",
      footerText:"Entworfen und erstellt von Burrow · 2025",
      toastAdded:"✅ Hinzugefügt",
      toastRemoved:"🗑️ Entfernt",
      toastExported:"📄 Exportiert",
      toastInstalledTray:"✅ In der App-Übersicht installiert",
      toastInstalled:"✅ App installiert",
      helperEmpty:"Bitte einen Namen eingeben",
      toastSoon:"Bald verfügbar",

      hungerTitle:"Hunger Check-in",
      hungerDesc:"Achte auf Körpersignale wie Hunger, Sättigung und Energie. Bald kommt hier ein einfaches Check-in ganz ohne Zahlen."
    }
  };

  function loadItems(){ try{ state.items=JSON.parse(localStorage.getItem(STORAGE_KEY))||[] }catch{ state.items=[]; } }
  function saveItems(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items)); }catch{} }
  function loadLang(){ lang=localStorage.getItem(LANG_KEY)||'en'; document.documentElement.lang=lang; }
  function saveLang(){ localStorage.setItem(LANG_KEY,lang); document.documentElement.lang=lang; }

  function applyI18n(){
    const t=i18n[lang];
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key=el.getAttribute('data-i18n'); if(t[key]!==undefined) el.textContent=t[key];
    });
    nameInput.placeholder = lang==='de'?'z. B. Cheeseburger':'e.g., Cheeseburger';
    switchEl.classList.toggle('active', lang==='de');
    installBtn.textContent = t.installBtn;
    render();
  }

  function render(){
    const t=i18n[lang];
    tbody.innerHTML='';
    emptyState.style.display = state.items.length ? 'none' : 'block';

    state.items.forEach((item,idx)=>{
      const tr=document.createElement('tr');

      const tdName=document.createElement('td'); tdName.textContent=item.name;
      const tdDairy=document.createElement('td');
      const pill=document.createElement('span');
      pill.className='pill ' + (item.dairy?'pill-yes':'pill-no');
      pill.textContent=item.dairy?t.pillYes:t.pillNo;
      tdDairy.appendChild(pill);

      const tdActions=document.createElement('td'); tdActions.className='row-actions';
      const rm=document.createElement('button');
      rm.className='btn btn-danger'; rm.type='button';
      rm.textContent = lang==='de'?'Entfernen':'Remove';
      rm.setAttribute('aria-label', (lang==='de'?'Entfernen ':'Remove ')+item.name);
      rm.addEventListener('click',()=>{
        state.items.splice(idx,1); saveItems(); render();
        showToast(t.toastRemoved, 1400);
      });
      tdActions.appendChild(rm);

      tr.appendChild(tdName); tr.appendChild(tdDairy); tr.appendChild(tdActions);
      tbody.appendChild(tr);
    });
  }

  function addItem(){
    const t=i18n[lang];
    const name=(nameInput.value||'').trim();
    if(!name){
      const help=document.getElementById('name-help');
      help.style.display='block'; help.textContent=t.helperEmpty;
      nameInput.animate?.([{transform:'translateX(0)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:150});
      nameInput.focus(); return;
    }
    document.getElementById('name-help').style.display='none';
    state.items.push({name, dairy:!!dairyCheckbox.checked}); saveItems(); render();
    nameInput.value=''; dairyCheckbox.checked=false; nameInput.focus();
    showToast(t.toastAdded, 1000);
  }

  function exportCSV(){
    const t=i18n[lang]; if(!state.items.length) return;
    try{
      const rows=[[t.thItem,t.thDairy], ...state.items.map(i=>[i.name, i.dairy? t.pillYes : t.pillNo])];
      const csv=rows.map(r=>r.map(f=>`"${String(f).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='mcFattys-log.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      state.items.length=0; saveItems(); render(); showToast(t.toastExported, 1400);
    }catch{ showToast('⚠️ Export failed', 1600); }
  }

  function openModal(){ modal.style.display='flex'; }
  function closeModal(){ modal.style.display='none'; }
  function clearAllNow(){ state.items.length=0; saveItems(); render(); }

  // Sidebar control
  function openSidebar(){
    sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false');
    scrim.classList.add('show'); scrim.setAttribute('aria-hidden','false');
    const firstBtn=sidebar.querySelector('.sb-item-btn'); firstBtn?.focus();
    document.addEventListener('keydown', escHandler);
    document.addEventListener('focus', focusTrap, true);
  }
  function closeSidebar(){
    sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true');
    scrim.classList.remove('show'); scrim.setAttribute('aria-hidden','true');
    menuOpen.focus();
    document.removeEventListener('keydown', escHandler);
    document.removeEventListener('focus', focusTrap, true);
  }
  function escHandler(e){ if(e.key==='Escape') closeSidebar(); }
  function focusTrap(e){
    if(!sidebar.classList.contains('open')) return;
    if(!sidebar.contains(e.target)){ e.stopPropagation(); sidebar.querySelector('.sb-item-btn')?.focus(); }
  }
  function scrollToId(id){
    const el=document.getElementById(id);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
  function handleMenuAction(action){
    const t=i18n[lang];
    switch(action){
      case 'newEntry':
        scrollToId('addItem'); closeSidebar(); break;
      case 'hungerCheck':
        scrollToId('hungerTitle'); closeSidebar(); break;
      default:
        showToast(t.toastSoon, 1200); closeSidebar(); break;
    }
  }

  // Bindings
  addBtn.addEventListener('click', addItem);
  nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addItem(); });
  exportBtn.addEventListener('click', exportCSV);
  clearBtn.addEventListener('click', openModal);
  cancelClear.addEventListener('click', closeModal);
  confirmClear.addEventListener('click', ()=>{ clearAllNow(); closeModal(); });

  langToggle.addEventListener('click', ()=>{ lang = (lang==='en') ? 'de' : 'en'; saveLang(); applyI18n(); });
  langToggle.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); langToggle.click(); } });

  menuOpen.addEventListener('click', openSidebar);
  menuClose.addEventListener('click', closeSidebar);
  scrim.addEventListener('click', closeSidebar);
  sidebar.addEventListener('click', e=>{
    const btn=e.target.closest('.sb-item-btn');
    if(btn){ handleMenuAction(btn.getAttribute('data-action')); }
  });

  // PWA
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  window.addEventListener('beforeinstallprompt',(e)=>{
    e.preventDefault(); deferredPrompt=e;
    if (!isStandalone()) installBtn.style.display='inline-flex';
  });
  installBtn.addEventListener('click', async ()=>{
    if(deferredPrompt){
      try{ deferredPrompt.prompt(); await deferredPrompt.userChoice; }catch{}
      deferredPrompt=null; installBtn.style.display='none';
    }
  });
  window.addEventListener('appinstalled', ()=>{
    const t=i18n[lang];
    const msg = /Android/i.test(navigator.userAgent) ? t.toastInstalledTray : t.toastInstalled;
    showToast(msg, 2200);
    installBtn.style.display='none';
  });
  function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true; }
  document.addEventListener('DOMContentLoaded', ()=>{ if(isStandalone()) installBtn.style.display='none'; });

  // Init
  loadLang(); loadItems(); applyI18n();
</script>